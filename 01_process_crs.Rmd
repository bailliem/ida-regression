---
title: "Process the CRS data set"
output:
  md_document:
    variant: gfm
    toc: true
    toc_depth: 2
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```


# Read data

Assumptions: 

* Basic reporting
* To aim at level 1 and 2, less emphasis on code modularity (i.e. user defined functions) 
* Code to be simple, readable, extendable. 



TODO: add variable to indicate measurement type:
* MH
* cormodoities
* outcome
Add additional metadata on measurement timing

## Set up

Set up packages and path to the data set. 

```{r setupR}
library(rmarkdown)
library(ggplot2)
library(dplyr)
library(Hmisc)
library(forcats)
library(patchwork)
library(here)
library(skimr)


## Set global ggplot theme
theme_set(theme_light())

## Relative path to the data set
crs_data_path = here("data", "crs.Rdata")
```

## Read data

Load the CRS dataset.

```{r}
load(crs_data_path)
```


## Check data

Check data contents and complete any misssing information including labels or units. 

display the data set contents. 

```{r}
Hmisc::contents(crs) 
```

Add missing label for BMI. 

```{r}
crs <- crs %>%
  Hmisc::upData(labels = c(bmi = 'body mass index'))
```

```{r}
crs %>% describe()
```




# Univariate data display

## Medical history

A summary of medical history measured at *diagnosis* (TODO: check when medical history / comorbidities was assessed). 

AFib, MI and CHF. 

```{r}
crs %>% 
  select(chf, afib, mi, diabetes) %>%
  Hmisc::describe()
```

```{r}

## TODO: Turn this in to a function
gg_chf <- 
  crs %>%
  select(chf) %>%
  mutate(chf = fct_recode(chf,
                          "no" = "0",
                          "yes"   = "1")) %>%
  ggplot(aes(chf)) +
  geom_bar() +
  coord_flip() +
  ggtitle("Congesitive heart failure") +
  ylab("Number of patients") +
  theme(
    panel.grid.minor = element_blank(),
    panel.grid.major.y = element_blank(),
    axis.title.y = element_blank()
  )
```


```{r}
gg_afib <- 
  crs %>%
  select(afib) %>%
  mutate(afib = fct_recode(afib,
                          "no" = "0",
                          "yes"   = "1")) %>%
  ggplot(aes(afib)) +
  geom_bar() +
  coord_flip() +
  ggtitle("Atrial fibrillation") +
  ylab("Number of patients") +
  theme(
    panel.grid.minor = element_blank(),
    panel.grid.major.y = element_blank(),
    axis.title.y = element_blank()
  )
```


```{r}
gg_mi <- 
  crs %>%
  select(mi) %>%
  mutate(mi = fct_recode(mi,
                          "no" = "0",
                          "yes"   = "1")) %>%
  ggplot(aes(mi)) +
  geom_bar() +
  coord_flip() +
  ggtitle("Myocardial infarction") +
  ylab("Number of patients") +
  theme(
    panel.grid.minor = element_blank(),
    panel.grid.major.y = element_blank(),
    axis.title.y = element_blank()
  )
```

Diabetes (type 1 and type2?)

```{r}
gg_dia <- 
  crs %>%
  select(diabetes) %>%
  mutate(diabetes = fct_recode(diabetes,
                          "no" = "0",
                          "yes"   = "1")) %>%
  ggplot(aes(diabetes)) +
  geom_bar() +
  coord_flip() +
  ggtitle("Diabetes") +
  ylab("Number of patients") +
  theme(
    panel.grid.minor = element_blank(),
    panel.grid.major.y = element_blank(),
    axis.title.y = element_blank()
  )
```


Plot of the distribution of patients with specific comorbidities measured at diagnosis. 

```{r}
(gg_chf + gg_afib) / (gg_mi + gg_dia)
```




## Patient characteristics 

```{r}
gg1 <- crs %>%
  ggplot(aes(y = bmi)) +
  geom_boxplot() +
  coord_flip() +
  theme_bw()
```


```{r}
gg1 
```


# Bivariate data display
